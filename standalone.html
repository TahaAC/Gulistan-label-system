<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
  <meta name="theme-color" content="#5cb85c" />
  <meta name="description" content="Barcode label printing system with camera scanning for Gulistan products" />
  
  <!-- iOS Meta Tags -->
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="apple-mobile-web-app-title" content="Gulistan Labels" />
  
  <!-- iOS Splash Screen -->
  <link rel="apple-touch-startup-image" href="logo.png" />
  
  <title>Gulistan Price Tags</title>
  
  <!-- Favicon and App Icons -->
  <link rel="icon" type="image/png" href="logo.png" />
  <link rel="apple-touch-icon" href="logo.png" />
  <link rel="apple-touch-icon" sizes="152x152" href="logo.png" />
  <link rel="apple-touch-icon" sizes="180x180" href="logo.png" />
  <link rel="apple-touch-icon" sizes="167x167" href="logo.png" />
  <link rel="manifest" href="manifest.json" />
  
  <style>
    :root {
      --primary: #2c3e50;
      --secondary: #3498db;
      --success: #27ae60;
      --danger: #e74c3c;
      --light: #ecf0f1;
      --dark: #2c3e50;
      --border: #bdc3c7;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: borde1r-box;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background-color: #f5f5f5;
      color: var(--dark);
      padding: 0;
      scroll-behavior: smooth;
      -webkit-overflow-scrolling: touch;
    }

    header {
      background-color: var(--primary);
      color: white;
      padding: 20px;
      text-align: center;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      position: sticky;
      top: 0;
      z-index: 1000;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }

    header h1 {
      font-size: 28px;
      margin: 0;
    }

    main {
      max-width: 1400px;
      margin: 20px auto;
      padding: 0 20px;
    }

    .row {
      display: flex;
      gap: 20px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }

    .glass-card {
      background-color: white;
      border: 1px solid var(--border);
      border-radius: 4px;
      padding: 20px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      flex: 1;
      min-width: 300px;
    }

    h3 {
      color: var(--primary);
      margin-bottom: 15px;
      font-size: 18px;
      border-bottom: 2px solid var(--secondary);
      padding-bottom: 10px;
    }

    label {
      display: block;
      margin-top: 10px;
      margin-bottom: 5px;
      color: var(--dark);
      font-weight: 500;
    }

    input[type="text"],
    input[type="number"],
    input[type="file"] {
      width: 100%;
      padding: 10px;
      margin-bottom: 10px;
      border: 1px solid var(--border);
      border-radius: 4px;
      font-size: 14px;
    }
    
    input[type="text"]:focus,
    input[type="number"]:focus {
      outline: none;
      border-color: var(--secondary);
      box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.2);
    }
    
    button {
      background-color: var(--secondary);
      color: white;
      border: none;
      padding: 10px 16px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      transition: background-color 0.2s;
    }

    button:hover {
      background-color: #2980b9;
    }

    button:disabled {
      background-color: #95a5a6;
      cursor: not-allowed;
    }

    .primary {
      background-color: var(--secondary);
    }

    .primary:hover {
      background-color: #2980b9;
    }

    .actions-group {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      margin-top: 15px;
    }

    .actions-group button {
      flex: 1;
      min-width: 120px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 15px;
    }

    table thead {
      background-color: var(--primary);
      color: white;
    }

    table th {
      padding: 12px;
      text-align: left;
      font-weight: 600;
      border: 1px solid var(--border);
    }

    table td {
      padding: 12px;
      border: 1px solid var(--border);
    }

    table tbody tr:nth-child(even) {
      background-color: #f9f9f9;
    }

    table tbody tr:hover {
      background-color: #f0f0f0;
    }

    .products-table-container {
      overflow-x: auto;
      margin-bottom: 15px;
      border: 1px solid var(--border);
      border-radius: 4px;
    }

    .search-box {
      width: 100%;
      padding: 12px;
      margin-bottom: 15px;
      border: 1px solid var(--border);
      border-radius: 4px;
      font-size: 14px;
    }

    .pagination {
      display: flex;
      gap: 10px;
      justify-content: center;
      align-items: center;
      margin-top: 15px;
    }

    .pagination button {
      min-width: 80px;
    }

    .page-info {
      color: var(--dark);
      font-weight: 500;
    }

    .print-actions {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      margin-top: 15px;
    }

    .print-actions button {
      flex: 1;
      min-width: 120px;
      background-color: var(--success);
    }

    .print-actions button:hover {
      background-color: #229954;
    }

    .action-btn {
      padding: 6px 10px;
      font-size: 12px;
      margin: 0 2px;
      white-space: nowrap;
    }

    .action-btn.add {
      background-color: var(--success);
    }

    .action-btn.add:hover {
      background-color: #229954;
    }

    .action-btn.edit {
      background-color: #f39c12;
    }

    .action-btn.edit:hover {
      background-color: #d68910;
    }

    .action-btn.delete {
      background-color: var(--danger);
    }

    .action-btn.delete:hover {
      background-color: #c0392b;
    }

    #loadStatus {
      color: var(--success);
      background-color: #d5f4e6;
      padding: 12px;
      border-radius: 4px;
      margin-bottom: 15px;
      border-left: 4px solid var(--success);
    }

    #selectionStatus {
      color: var(--dark);
      font-size: 14px;
    }

    /* Edit Modal */
    #editModal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
      z-index: 1000;
      justify-content: center;
      align-items: center;
    }

    #editModal.active {
      display: flex;
    }

    #editModal > div {
      background-color: white;
      border: 1px solid var(--border);
      border-radius: 4px;
      padding: 30px;
      max-width: 400px;
      width: 90%;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
    }

    #editModal h2 {
      color: var(--primary);
      margin-bottom: 20px;
    }

    #editModal label {
      display: block;
      margin-top: 15px;
      margin-bottom: 5px;
      color: var(--dark);
      font-weight: 500;
    }

    #editModal input {
      width: 100%;
      padding: 10px;
      margin-bottom: 15px;
      border: 1px solid var(--border);
      border-radius: 4px;
      font-size: 14px;
    }

    #editModal .actions-group {
      margin-top: 20px;
    }

    /* Labels Preview */
    #labelsGrid {
      display: grid;
      grid-template-columns: repeat(3, 63.5mm);
      gap: 0;
      padding: 0;
      justify-content: center;
      margin-top: 20px;
      background-color: white;
      border: none;
      border-radius: 0;
    }

    .labels-grid {
      display: grid;
      grid-template-columns: repeat(3, 63.5mm);
      gap: 0;
      padding: 0;
      justify-content: center;
      background: white;
      border-radius: 0;
    }

    .label {
      width: 63.5mm;
      height: 20mm;
      border: 1px solid #000;
      border-radius: 0;
      padding: 1.5mm;
      display: flex;
      flex-direction: column;
      justify-content: flex-start;
      background: white;
      box-sizing: border-box;
      page-break-inside: avoid;
    }

    .label .name { 
      font-size: 11pt; 
      font-weight: 700; 
      color: #000; 
      line-height: 1.1;
      margin: 0 0 0.5mm 0;
      padding: 0;
      text-align: center;
      word-wrap: break-word;
      overflow-wrap: break-word;
      display: block;
      max-height: 6mm;
      overflow: hidden;
    }

    /* Smaller font for long product names */
    .label .name.long-name {
      font-size: 9pt;
      line-height: 1.0;
    }

    .label .barcode-container {
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 0.3mm 0;
      background: white;
      margin: 0.3mm 5px;
      flex: 0 0 auto;
    }

    .label .barcode { 
      width: 100%; 
      height: 3mm;
      display: block;
    }

    .label .price { 
      font-size: 24pt; 
      font-weight: 900; 
      text-align: center; 
      color: #000;
      margin-top: 0.3mm;
      letter-spacing: 0;
      line-height: 1;
    }

    /* Mobile-friendly label preview (screen only) */
    @media screen and (max-width: 768px) {
      .labels-card {
        overflow-x: auto;
      }

      #labelsGrid,
      .labels-grid {
        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
        gap: 12px;
        padding: 12px;
        width: 100%;
        box-sizing: border-box;
      }

      .label {
        width: 100%;
        min-width: 220px;
        height: auto;
        min-height: 120px;
      }

      .label .name {
        max-height: none;
        white-space: normal;
      }

      .label .barcode {
        height: 28px;
      }
    }

    .label .sku {
      font-size: 8pt;
      text-align: center;
      color: #000;
      font-family: 'Courier New', monospace;
      margin-top: 1mm;
    }

    /* Modal */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
      z-index: 1000;
      justify-content: center;
      align-items: center;
    }

    .modal.active {
      display: flex;
    }

    .modal-content {
      background-color: white;
      border: 1px solid var(--border);
      border-radius: 4px;
      padding: 30px;
      max-width: 400px;
      width: 90%;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .close-btn {
      background: none;
      border: none;
      font-size: 24px;
      cursor: pointer;
      color: var(--dark);
    }

    .close-btn:hover {
      color: var(--danger);
    }

    .form-group {
      margin-bottom: 15px;
    }

    /* Barcode Dropdown Autocomplete */
    .barcode-dropdown {
      position: absolute;
      background: var(--glass-bg);
      border: 1px solid var(--border);
      border-top: none;
      border-radius: 0 0 8px 8px;
      max-height: 300px;
      overflow-y: auto;
      width: 100%;
      z-index: 1000;
      display: none;
      backdrop-filter: blur(10px);
    }

    .barcode-dropdown-item {
      padding: 12px;
      display: grid;
      grid-template-columns: 100px 1fr 80px;
      gap: 10px;
      align-items: center;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      cursor: pointer;
      transition: background 0.2s ease;
      font-size: 13px;
    }

    .barcode-dropdown-item:hover {
      background: rgba(92, 184, 92, 0.1);
      border-left: 3px solid #5cb85c;
      padding-left: 9px;
    }

    .dropdown-barcode {
      font-weight: 600;
      color: var(--success);
      font-family: monospace;
    }

    .dropdown-name {
      color: var(--text);
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .dropdown-price {
      color: var(--primary);
      font-weight: 500;
    }

    /* Input wrapper for dropdown positioning */
    .barcode-input-wrapper {
      position: relative;
    }

    /* Camera Scanner Constraints */
    #cameraVideo video,
    #cameraVideo canvas {
      max-width: 280px !important;
      max-height: 180px !important;
      width: 280px !important;
      height: 180px !important;
      object-fit: cover !important;
    }

    #cameraScannerSection {
      max-width: 280px !important;
      margin-left: auto !important;
      margin-right: auto !important;
    }

    /* Responsive Design */
    @media (max-width: 768px) {
      header {
        text-align: center;
        flex-direction: column;
        padding: 15px 10px;
      }

      header h1 {
        font-size: 22px;
      }

      header button {
        float: none !important;
        margin: 5px auto !important;
        width: 90%;
      }

      .row {
        flex-direction: column;
      }

      .glass-card {
        min-width: 100%;
      }

      .actions-group button {
        width: 100%;
        font-size: 16px;
        padding: 14px;
        touch-action: manipulation;
      }

      button.primary {
        min-height: 48px;
        font-size: 16px;
        touch-action: manipulation;
      }

      input, select, textarea {
        font-size: 16px;
        padding: 12px;
        touch-action: manipulation;
      }

      table th,
      table td {
        font-size: 13px;
        padding: 10px 8px;
      }
    }

    @media (max-width: 480px) {
      body {
        padding: 12px;
        -webkit-overflow-scrolling: touch;
      }

      header {
        position: sticky;
        top: 0;
        z-index: 100;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        margin: -20px -20px 20px -20px;
        padding: 15px 20px;
      }

      header h1 {
        font-size: 20px;
      }

      .glass-card {
        padding: 16px;
      }

      .row {
        flex-direction: column;
        gap: 12px;
      }

      .actions-group {
        flex-direction: column;
      }

      #cameraVideo {
        max-width: 100% !important;
        width: 100% !important;
      }
    }

    /* iOS Specific Fixes */
    @supports (-webkit-touch-callout: none) {
      body {
        -webkit-user-select: none;
      }

      input, textarea, select {
        -webkit-user-select: text;
      }

      button {
        -webkit-tap-highlight-color: rgba(0, 0, 0, 0.1);
      }

      /* Fix iOS Safari bottom bar */
      body {
        padding-bottom: env(safe-area-inset-bottom);
      }

      header {
        padding-top: env(safe-area-inset-top);
      }
    }

      .actions-group button {
        width: 100%;
      }

      .search-box,
      input[type="text"],
      input[type="number"] {
        width: 100%;
      }

      table {
        min-width: 100%;
      }

      table th,
      table td {
        font-size: 12px;
        padding: 8px;
      }

      .pagination {
        flex-direction: column;
        gap: 6px;
      }

      .pagination button {
        width: 100%;
      }
    }

    /* Print CSS */
    @media print {
      @page {
        size: A4 portrait;
        margin: 2.5mm;
      }

      * {
        -webkit-print-color-adjust: exact !important;
        print-color-adjust: exact !important;
        color-adjust: exact !important;
      }

      body { 
        background: white !important;
        margin: 0 !important;
        padding: 0 !important;
      }

      header,
      main > .row > .glass-card:not(.labels-card),
      .controls,
      .queue-card,
      .search-box,
      input[type="file"],
      button,
      label,
      p { 
        display: none !important; 
      }

      main {
        padding: 0 !important;
        margin: 0 auto !important;
        max-width: 210mm !important;
        width: 210mm !important;
      }

      .glass-card {
        display: none !important;
      }

      .labels-card {
        display: block !important;
        background: white !important;
        border: none !important;
        padding: 0 !important;
        margin: 0 !important;
        box-shadow: none !important;
      }

      #labelsGrid,
      .labels-grid { 
        display: grid !important;
        grid-template-columns: repeat(3, 63.5mm) !important;
        grid-template-rows: repeat(7, 28.1mm) !important;
        gap: 0 !important;
        width: 205mm !important;
        height: 210mm !important;
        padding: 0 !important;
        margin: 0 !important;
        background: white !important;
        border: none !important;
        page-break-inside: avoid !important;
      }

      .label {
        width: 63.5mm !important;
        height: 28.1mm !important;
        min-width: 63.5mm !important;
        max-width: 63.5mm !important;
        min-height: 28.1mm !important;
        max-height: 28.1mm !important;
        background: white !important;
        border: 1px solid #000 !important;
        border-radius: 0 !important;
        padding: 1.5mm !important;
        margin: 0 !important;
        page-break-inside: avoid !important;
        display: flex !important;
        flex-direction: column !important;
        justify-content: flex-start !important;
        box-sizing: border-box !important;
      }

      .label .name {
        font-size: 11pt !important;
        font-weight: 700 !important;
        color: #000 !important;
        line-height: 1.1 !important;
        margin: 0 0 0.5mm 0 !important;
        padding: 0 !important;
        text-align: center !important;
        word-wrap: break-word !important;
        overflow-wrap: break-word !important;
        display: block !important;
        max-height: 6mm !important;
        overflow: hidden !important;
      }

      .label .name.long-name {
        font-size: 9pt !important;
        line-height: 1.0 !important;
      }

      .label .barcode-container {
        display: flex !important;
        justify-content: center !important;
        align-items: center !important;
        padding: 0.3mm 0 !important;
        background: white !important;
        margin: 0.3mm 4px !important;
        flex: 0 0 auto !important;
      }

      .label .barcode {
        width: 100% !important;
        height: 6mm !important;
        min-height: 6mm !important;
        max-height: 6mm !important;
        display: block !important;
      }

      .label .price {
        font-size: 24pt !important;
        font-weight: 900 !important;
        text-align: center !important;
        color: #000 !important;
        margin: 0.3mm 0 0 0 !important;
        padding: 0 !important;
        letter-spacing: 0 !important;
        line-height: 1 !important;
      }

      .label .sku {
        font-size: 8pt !important;
        text-align: center !important;
        color: #000 !important;
        font-family: 'Courier New', monospace !important;
        margin-top: 0.5mm !important;
      }
    }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.6/dist/JsBarcode.all.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/quagga@0.12.1/dist/quagga.min.js"></script>
  
  <!-- Firebase SDK -->
  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
    import { getFirestore, collection, getDocs, addDoc, updateDoc, deleteDoc, doc, onSnapshot } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

    // Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyCAWRe2ok2Hu-f3nxddDQ6WJ3e7bKly9Ro",
      authDomain: "barcode-printing-system.firebaseapp.com",
      projectId: "barcode-printing-system",
      storageBucket: "barcode-printing-system.firebasestorage.app",
      messagingSenderId: "329743572390",
      appId: "1:329743572390:web:4e59f1a998379f9cd84367"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // Make Firebase available globally
    window.firebaseDB = db;
    window.firebaseCollection = collection;
    window.firebaseGetDocs = getDocs;
    window.firebaseAddDoc = addDoc;
    window.firebaseUpdateDoc = updateDoc;
    window.firebaseDeleteDoc = deleteDoc;
    window.firebaseDoc = doc;
    window.firebaseOnSnapshot = onSnapshot;
    window.firebaseInitialized = true;

    console.log('Firebase initialized successfully');
  </script>
  
  <script>
    // Verify Quagga is loaded
    window.addEventListener('load', function() {
      if (typeof Quagga !== 'undefined') {
        console.log('Quagga barcode scanner library loaded successfully');
      } else {
        console.error('Quagga library failed to load');
      }
    });
  </script>
  <!-- Inline dataset for instant availability when opened directly -->
  <script src="productData-inline.js"></script>
  <script>
    // Map productData to productDataInline for compatibility
    if (typeof productData !== 'undefined') {
      window.productDataInline = productData;
    }
  </script>
  <script>
    const products = []; // {barcode, name, price}
    const queue = [];    // {barcode, name, price, quantity}
    const selectedForPrint = new Set(); // Track selected barcodes for printing
    let filteredProducts = [];
    let currentPage = 1;
    const itemsPerPage = 50;
    let editingProductIndex = -1;
    let cameraActive = false;
    let lastDetectedBarcode = '';
    let currentScanTarget = null; // Track which input field is being scanned

    // Elements
    let scannerInput, queueTbody, labelsGrid, loadStatus, productsTbody;

    function sanitizePrice(raw) {
      if (!raw) return '0.00';
      const s = String(raw).replace(/\$/g, '').trim();
      const n = Number(s);
      return Number.isFinite(n) ? n.toFixed(2) : s;
    }

    function normalize(item) {
      let barcode = String(item.barcode || '').trim();
      let name = String(item.name || '').trim();
      
      // If barcode field contains both numbers and text (e.g., "016061009101003 Fruit Roil")
      // Extract the numeric part and the text part separately
      if (barcode) {
        const match = barcode.match(/^(\d+)\s+(.+)$/);
        if (match) {
          barcode = match[1]; // Numeric part
          if (!name || name === 'GROCERY') {
            name = match[2]; // Text part as product name
          }
        } else {
          // Just numbers in barcode field, keep as is
          barcode = barcode.replace(/\D/g, '').trim();
        }
      }
      
      // Remove "GROCERY" from name if it's the only text
      if (name === 'GROCERY' || name === '') {
        name = 'Product';
      } else {
        name = name.replace(/\bGROCERY\b/gi, '').trim();
      }
      
      // If barcode is all zeros or empty, generate from product name
      if (!barcode || /^0+$/.test(barcode)) {
        barcode = generateBarcodeFromName(name || 'Product');
      }
      
      return {
        barcode,
        name: name || 'Product',
        price: sanitizePrice(item.price || '0')
      };
    }

    function setProducts(list) {
      products.splice(0, products.length, ...list.map(normalize));
      loadStatus.textContent = `Loaded ${products.length} products.`;
      loadStatus.style.display = 'inline-block';
      filteredProducts = [...products];
      renderProducts();
      saveProductsToFirebase(); // Auto-sync to Firebase
    }

    // Firebase Functions
    async function saveProductsToFirebase() {
      if (!window.firebaseInitialized || products.length === 0) return;
      
      try {
        const productsRef = window.firebaseCollection(window.firebaseDB, 'products');
        
        // Clear existing products first
        const snapshot = await window.firebaseGetDocs(productsRef);
        const deletePromises = snapshot.docs.map(doc => window.firebaseDeleteDoc(doc.ref));
        await Promise.all(deletePromises);
        
        // Add all products
        const addPromises = products.map(product => 
          window.firebaseAddDoc(productsRef, product)
        );
        await Promise.all(addPromises);
        
        console.log(`Synced ${products.length} products to Firebase`);
      } catch (error) {
        console.error('Firebase sync error:', error);
      }
    }

    async function loadProductsFromFirebase() {
      if (!window.firebaseInitialized) return false;
      
      try {
        const productsRef = window.firebaseCollection(window.firebaseDB, 'products');
        const snapshot = await window.firebaseGetDocs(productsRef);
        
        if (snapshot.empty) {
          console.log('No products found in Firebase');
          return false;
        }
        
        const firebaseProducts = snapshot.docs.map(doc => doc.data());
        products.splice(0, products.length, ...firebaseProducts.map(normalize));
        loadStatus.textContent = `Loaded ${products.length} products from Firebase`;
        loadStatus.style.display = 'inline-block';
        filteredProducts = [...products];
        renderProducts();
        
        console.log(`Loaded ${products.length} products from Firebase`);
        return true;
      } catch (error) {
        console.error('Firebase load error:', error);
        return false;
      }
    }

    async function addProductToFirebase(product) {
      if (!window.firebaseInitialized) return;
      
      try {
        const productsRef = window.firebaseCollection(window.firebaseDB, 'products');
        await window.firebaseAddDoc(productsRef, product);
        console.log('Product added to Firebase:', product.barcode);
      } catch (error) {
        console.error('Firebase add error:', error);
      }
    }

    async function deleteProductFromFirebase(barcode) {
      if (!window.firebaseInitialized) return;
      
      try {
        const productsRef = window.firebaseCollection(window.firebaseDB, 'products');
        const snapshot = await window.firebaseGetDocs(productsRef);
        
        const docToDelete = snapshot.docs.find(doc => doc.data().barcode === barcode);
        if (docToDelete) {
          await window.firebaseDeleteDoc(docToDelete.ref);
          console.log('Product deleted from Firebase:', barcode);
        }
      } catch (error) {
        console.error('Firebase delete error:', error);
      }
    }

    // Wrapper functions for UI buttons
    async function syncToFirebase() {
      if (!window.firebaseInitialized) {
        alert('Firebase is not initialized. Please refresh the page.');
        return;
      }
      
      if (products.length === 0) {
        alert('No products to sync. Load products first.');
        return;
      }
      
      const confirmSync = confirm(`Sync ${products.length} products to Firebase Cloud?\n\nThis will replace all existing cloud data.`);
      if (!confirmSync) return;
      
      loadStatus.textContent = 'Syncing to cloud...';
      loadStatus.style.display = 'block';
      
      await saveProductsToFirebase();
      
      loadStatus.textContent = `Successfully synced ${products.length} products to Firebase Cloud`;
      loadStatus.style.display = 'block';
      
      setTimeout(() => {
        loadStatus.textContent = `Loaded ${products.length} products.`;
      }, 3000);
    }

    async function loadFromFirebase() {
      if (!window.firebaseInitialized) {
        alert('Firebase is not initialized. Please refresh the page.');
        return;
      }
      
      const confirmLoad = confirm('Load products from Firebase Cloud?\n\nThis will replace current local data.');
      if (!confirmLoad) return;
      
      loadStatus.textContent = 'Loading from cloud...';
      loadStatus.style.display = 'block';
      
      const loaded = await loadProductsFromFirebase();
      
      if (!loaded) {
        alert('No products found in Firebase. Use "Sync to Cloud" to upload products first.');
        loadStatus.textContent = 'No data in cloud.';
      }
    }

    function upsertQueueItem(item) {
      const existing = queue.find(q => q.barcode === item.barcode);
      if (existing) {
        existing.quantity += item.quantity || 1;
      } else {
        queue.push({ ...item, quantity: item.quantity || 1 });
      }
      renderQueue();
      renderLabels();
    }

    function removeQueueItem(barcode) {
      const idx = queue.findIndex(q => q.barcode === barcode);
      if (idx !== -1) {
        queue.splice(idx, 1);
        renderQueue();
        renderLabels();
      }
    }

    function setQueueQty(barcode, qty) {
      const item = queue.find(q => q.barcode === barcode);
      if (item) {
        item.quantity = Math.max(1, Number(qty) || 1);
        renderQueue();
        renderLabels();
      }
    }

    function exportToExcel() {
      if (selectedForPrint.size === 0) {
        alert('Please select at least one product to export!');
        return;
      }
      
      // Create CSV content
      let csvContent = 'Barcode,Product Name,Price,Quantity\n';
      
      for (const q of queue) {
        if (selectedForPrint.has(q.barcode)) {
          const name = q.name.toUpperCase().replace(/"/g, '""'); // Escape quotes
          const row = `"${q.barcode}","${name}",${q.price},${q.quantity}`;
          csvContent += row + '\n';
        }
      }
      
      // Create blob and download
      const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement('a');
      const url = URL.createObjectURL(blob);
      link.setAttribute('href', url);
      link.setAttribute('download', `gulistan-labels-${new Date().toISOString().slice(0, 10)}.csv`);
      link.style.visibility = 'hidden';
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    }

    function clearQueue() {
      queue.splice(0, queue.length);
      renderQueue();
      renderLabels();
    }

    function renderQueue() {
      queueTbody.innerHTML = '';
      document.getElementById('queueCount').textContent = queue.length;
      for (const q of queue) {
        const tr = document.createElement('tr');
        const isSelected = selectedForPrint.has(q.barcode);
        tr.innerHTML = `
          <td style="width: 40px;">
            <input type="checkbox" ${isSelected ? 'checked' : ''} onchange="toggleSelection('${q.barcode}')" />
          </td>
          <td>${q.barcode}</td>
          <td>${q.name}</td>
          <td>$${sanitizePrice(q.price)}</td>
          <td>
            <input type="number" min="1" value="${q.quantity}" style="width:80px; padding:8px; background:rgba(255,255,255,0.2); border:1px solid rgba(255,255,255,0.3); border-radius:8px; color:#fff;" />
          </td>
          <td>
            <button onclick="removeQueueItem('${q.barcode}')">Remove</button>
          </td>
        `;
        const qtyInput = tr.querySelector('input[type="number"]');
        qtyInput.addEventListener('change', (e) => setQueueQty(q.barcode, e.target.value));
        queueTbody.appendChild(tr);
      }
    }

    function renderLabels() {
      labelsGrid.innerHTML = '';
      labelsGrid.style.display = 'grid';
      
      // Add back button for mobile print preview
      if (window.innerWidth < 768) {
        const backBtn = document.createElement('button');
        backBtn.textContent = 'Back to Queue';
        backBtn.className = 'primary';
        backBtn.style.cssText = 'position: sticky; top: 20px; width: 100%; margin-bottom: 20px; z-index: 10;';
        backBtn.onclick = () => {
          labelsGrid.innerHTML = '';
          labelsGrid.style.display = 'none';
          const queueActions = document.querySelector('.queue-card .print-actions');
          if (queueActions) queueActions.style.display = 'flex';
        };
        labelsGrid.appendChild(backBtn);
      }
      
      for (const q of queue) {
        // Only render if selected for print or if no selection yet (show all)
        if (selectedForPrint.size > 0 && !selectedForPrint.has(q.barcode)) {
          continue;
        }
        
        for (let i = 0; i < q.quantity; i++) {
          const div = document.createElement('div');
          div.className = 'label';
          const svgId = `svg_${q.barcode}_${i}_${Math.random().toString(36).slice(2)}`;
          const nameClass = q.name.length > 30 ? 'name long-name' : 'name';
          div.innerHTML = `
            <div class="${nameClass}">${q.name.toUpperCase()}</div>
            <div class="price">$${sanitizePrice(q.price)}</div>
            <div class="barcode-container">
              <svg id="${svgId}" class="barcode" data-barcode="${q.barcode}"></svg>
            </div>
          `;
          labelsGrid.appendChild(div);
          try {
            // CODE128: Industry standard for alphanumeric data
            // SVG: Vector format - never pixelates, perfect for scanning
            JsBarcode(`#${svgId}`, q.barcode, { 
              format: 'CODE128',
              width: 1.5,
              height: 20,
              displayValue: false,
              margin: 0, // Quiet zone handled by CSS
              background: '#ffffff',
              lineColor: '#000000'
            });
          } catch (e) {
            const svg = div.querySelector('svg');
            svg.replaceWith(Object.assign(document.createElement('div'), { 
              textContent: q.barcode, 
              className: 'barcode', 
              style: 'display:flex;align-items:center;justify-content:center;font-size:10pt;border:1px dashed #ccc;background:white;color:#000;' 
            }));
          }
        }
      }
      
      // Save selected items to localStorage
      localStorage.setItem('gulistanSelectedItems', JSON.stringify(Array.from(selectedForPrint)));
    }

    function generateBarcodeFromName(name) {
      // Create a numeric barcode from product name using hash algorithm
      let hash = 0;
      const cleanName = name.trim().toUpperCase();
      
      for (let i = 0; i < cleanName.length; i++) {
        const char = cleanName.charCodeAt(i);
        hash = ((hash << 5) - hash) + char;
        hash = hash & hash; // Convert to 32-bit integer
      }
      
      // Convert to positive 13-digit number (EAN-13 compatible)
      const barcode = Math.abs(hash).toString().slice(0, 12).padStart(12, '0');
      return barcode + (Math.abs(hash) % 10).toString(); // Add check digit
    }

    function handleNameInput() {
      const nameInput = document.getElementById('manualName');
      const barcodeInput = document.getElementById('manualBarcode');
      const name = nameInput.value.trim();
      
      if (name.length > 0) {
        // Auto-generate barcode from product name
        const generatedBarcode = generateBarcodeFromName(name);
        barcodeInput.value = generatedBarcode;
      }
    }

    async function handleFile(evt) {
      const file = evt.target.files?.[0];
      if (!file) return;
      loadStatus.textContent = 'Reading…';
      loadStatus.style.display = 'inline-block';
      const text = await file.text();
      const lines = text.split(/\r?\n/).filter(l => l.trim().length);
      if (lines.length < 2) {
        loadStatus.textContent = 'No data found in file.';
        loadStatus.style.display = 'inline-block';
        return;
      }
      const headers = lines[0].split(/\t/).map(h => h.trim());
      const idx = (name) => headers.findIndex(h => h.toLowerCase() === name.toLowerCase());
      const iDesc = idx('Description1');
      const iCode = idx('Product Code');
      const iBarcode1 = idx('Barcode1');
      const iPrice1 = idx('Price1');
      const next = [];
      for (let i = 1; i < lines.length; i++) {
        const cols = lines[i].split(/\t/);
        let name = (cols[iDesc] || '').trim();
        const code = (cols[iCode] || '').trim();
        const b1 = (cols[iBarcode1] || '').trim();
        const price = sanitizePrice(cols[iPrice1] || '0');
        
        // Prefer Barcode1 if numeric, otherwise use Product Code if numeric
        let barcode = '';
        if (b1 && /^\d+$/.test(b1)) {
          barcode = b1;
        } else if (code && /^\d+$/.test(code)) {
          barcode = code;
        } else if (name) {
          // Generate barcode from product name if no numeric barcode found
          barcode = generateBarcodeFromName(name);
        }
        
        if (!barcode || !name) continue;
        next.push({ barcode, name, price });
      }
      setProducts(next);
      scannerInput.focus();
    }

    function loadSample() {
      setProducts([
        { barcode: '9301234567890', name: 'Afghan Almond 500g', price: '11.99' },
        { barcode: '9300000000001', name: 'Green Raisins 500g', price: '9.99' },
        { barcode: '9300000000002', name: 'Sour Apricot 500g', price: '7.50' }
      ]);
      scannerInput.focus();
    }

    function handleScanSubmit(e) {
      e.preventDefault();
      const code = scannerInput.value.trim();
      if (!code) return;
      const prod = products.find(p => p.barcode === code);
      if (!prod) {
        alert(`Product with barcode "${code}" is not registered in the system.\n\nPlease add this product to the database first using the "Add Product" option.`);
        scannerInput.value = '';
        scannerInput.focus();
        return;
      }
      upsertQueueItem({ barcode: prod.barcode, name: prod.name, price: prod.price, quantity: 1 });
      scannerInput.value = '';
      scannerInput.focus();
    }

    function startCameraScanner(targetInputId = 'scannerInput') {
      // Check if Quagga is loaded
      if (typeof Quagga === 'undefined') {
        alert('Camera scanner library not loaded. Please refresh the page.');
        return;
      }

      if (cameraActive) {
        stopCameraScanner();
        return;
      }

      cameraActive = true;
      currentScanTarget = targetInputId;
      
      // Show the camera video element
      const cameraSection = document.getElementById('cameraScannerSection');
      if (cameraSection) cameraSection.style.display = 'block';
      
      // Update button states
      const btn = document.getElementById('toggleCameraBtn');
      if (btn) {
        btn.textContent = 'Stop Camera';
        btn.style.backgroundColor = '#d9534f';
      }
      
      const statusEl = document.getElementById('cameraStatus');
      if (statusEl) statusEl.style.display = 'block';

      console.log('Starting camera scanner for:', targetInputId);

      // Simplified high-accuracy Quagga configuration
      Quagga.init({
        inputStream: {
          name: 'Live',
          type: 'LiveStream',
          target: document.querySelector('#cameraVideo'),
          constraints: {
            width: { ideal: 1280 },
            height: { ideal: 720 },
            facingMode: 'environment'
          }
        },
        frequency: 10,
        decoder: {
          readers: [
            'code_128_reader',
            'ean_reader',
            'ean_8_reader',
            'code_39_reader',
            'upc_reader',
            'upc_e_reader'
          ]
        },
        locate: true,
        locator: {
          halfSample: true,
          patchSize: "medium"
        }
      }, function(err) {
        if (err) {
          console.error('Camera initialization error:', err);
          alert('Camera failed:\n' + err.message + '\n\nPlease:\n1. Allow camera permissions\n2. Use HTTPS or localhost\n3. Check if another app is using camera');
          stopCameraScanner();
          return;
        }
        
        console.log('Camera started');
        Quagga.start();

        Quagga.onDetected(function(result) {
          if (!result || !result.codeResult || !result.codeResult.code) return;
          
          const code = result.codeResult.code;
          
          // Prevent duplicate detections
          if (code === lastDetectedBarcode) return;
          
          lastDetectedBarcode = code;
          console.log('Barcode detected:', code);
          
          // Get the target input field
          const targetInput = document.getElementById(currentScanTarget);
          if (targetInput) {
            targetInput.value = code;
            targetInput.focus();
            
            // Trigger appropriate action based on which input
            if (currentScanTarget === 'scannerInput') {
              const results = searchBarcodeProducts(code);
              showBarcodeDropdown(results, 'scannerDropdown', false);
            } else if (currentScanTarget === 'manualBarcode') {
              const results = searchBarcodeProducts(code);
              showBarcodeDropdown(results, 'manualBarcodeDropdown', true);
            } else if (currentScanTarget === 'searchProducts') {
              const results = searchBarcodeProducts(code);
              showBarcodeDropdown(results, 'searchProductsDropdown', false);
              filterProducts();
            }
            
            // Audio feedback
            try {
              const beep = new AudioContext();
              const oscillator = beep.createOscillator();
              oscillator.frequency.value = 800;
              const gainNode = beep.createGain();
              oscillator.connect(gainNode);
              gainNode.connect(beep.destination);
              gainNode.gain.value = 0.3;
              oscillator.start();
              setTimeout(() => oscillator.stop(), 100);
            } catch (e) {}
          }
          
          // Reset after delay
          setTimeout(() => { lastDetectedBarcode = ''; }, 1500);
        });
      });
    }

    function stopCameraScanner() {
      cameraActive = false;
      currentScanTarget = null;
      
      if (typeof Quagga !== 'undefined' && Quagga.isRunning && Quagga.isRunning()) {
        Quagga.stop();
        Quagga.offDetected();
      }
      
      const cameraSection = document.getElementById('cameraScannerSection');
      if (cameraSection) cameraSection.style.display = 'none';
      
      const btn = document.getElementById('toggleCameraBtn');
      if (btn) {
        btn.textContent = 'Start Camera';
        btn.style.backgroundColor = '#5cb85c';
      }
      
      const statusEl = document.getElementById('cameraStatus');
      if (statusEl) statusEl.style.display = 'none';
      
      console.log('Camera scanner stopped');
    }

    function handleManualAdd(e) {
      e.preventDefault();
      const b = document.getElementById('manualBarcode').value.trim();
      const n = document.getElementById('manualName').value.trim();
      const p = document.getElementById('manualPrice').value.trim();
      if (!b || !n || !p) { alert('Please fill barcode, name, and price.'); return; }
      const entry = { barcode: b, name: n, price: sanitizePrice(p) };
      products.push(entry);
      addProductToFirebase(entry); // Sync to Firebase
      upsertQueueItem({ ...entry, quantity: 1 });
      resetManual();
    }

    function resetManual() {
      document.getElementById('manualBarcode').value = '';
      document.getElementById('manualName').value = '';
      document.getElementById('manualPrice').value = '';
    }

    function renderProducts() {
      const start = (currentPage - 1) * itemsPerPage;
      const end = start + itemsPerPage;
      const pageProducts = filteredProducts.slice(start, end);
      
      productsTbody.innerHTML = '';
      document.getElementById('productsCount').textContent = filteredProducts.length;
      
      for (let i = 0; i < pageProducts.length; i++) {
        const p = pageProducts[i];
        const actualIndex = products.findIndex(prod => prod.barcode === p.barcode);
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td style="width:40px; text-align:center;"><input type="checkbox" onchange="toggleProductSelection('${p.barcode}')" ${selectedForPrint.has(p.barcode) ? 'checked' : ''}></td>
          <td style="font-family: 'Courier New', monospace;">${p.barcode}</td>
          <td>${p.name}</td>
          <td>$${sanitizePrice(p.price)}</td>
          <td>
            <button class="action-btn add" onclick="addProductToQueue('${p.barcode}')">➕ Add</button>
            <button class="action-btn edit" onclick="editProduct(${actualIndex})">Edit</button>
            <button class="action-btn delete" onclick="deleteProduct(${actualIndex})">Delete</button>
          </td>
        `;
        productsTbody.appendChild(tr);
      }
      
      updatePagination();
    }

    function updatePagination() {
      const totalPages = Math.ceil(filteredProducts.length / itemsPerPage);
      document.getElementById('currentPage').textContent = currentPage;
      document.getElementById('totalPages').textContent = totalPages;
      document.getElementById('prevPageBtn').disabled = currentPage === 1;
      document.getElementById('nextPageBtn').disabled = currentPage >= totalPages;
    }

    function changePage(delta) {
      const totalPages = Math.ceil(filteredProducts.length / itemsPerPage);
      currentPage = Math.max(1, Math.min(currentPage + delta, totalPages));
      renderProducts();
      document.querySelector('.products-table-container').scrollTop = 0;
    }

    function filterProducts() {
      const searchTerm = document.getElementById('searchProducts').value.toLowerCase().trim();
      if (!searchTerm) {
        filteredProducts = [...products];
      } else {
        filteredProducts = products.filter(p => 
          p.name.toLowerCase().includes(searchTerm) ||
          p.barcode.toLowerCase().includes(searchTerm) ||
          p.price.includes(searchTerm)
        );
      }
      currentPage = 1;
      renderProducts();
    }

    // Barcode search and autocomplete
    function searchBarcodeProducts(searchTerm) {
      if (!searchTerm || searchTerm.length === 0) return [];
      const lowerSearch = searchTerm.toLowerCase();
      return products.filter(p => 
        p.barcode.toLowerCase().includes(lowerSearch) ||
        p.name.toLowerCase().includes(lowerSearch)
      ).slice(0, 10);
    }

    function showBarcodeDropdown(results, targetDropdownId, isManual) {
      const dropdown = document.getElementById(targetDropdownId);
      if (!results || results.length === 0) {
        dropdown.style.display = 'none';
        return;
      }
      
      dropdown.innerHTML = results.map((prod) => `
        <div class="barcode-dropdown-item" data-barcode="${prod.barcode}" data-name="${prod.name}" data-price="${prod.price}" style="cursor: pointer;">
          <div class="dropdown-barcode">${prod.barcode}</div>
          <div class="dropdown-name">${prod.name}</div>
          <div class="dropdown-price">$${sanitizePrice(prod.price)}</div>
        </div>
      `).join('');
      
      // Add click handlers to dropdown items
      const items = dropdown.querySelectorAll('.barcode-dropdown-item');
      items.forEach(item => {
        item.addEventListener('click', function() {
          const barcode = this.getAttribute('data-barcode');
          const name = this.getAttribute('data-name');
          const price = this.getAttribute('data-price');
          
          if (isManual) {
            selectFromManualDropdown(barcode, name, price);
          } else {
            selectFromScannerDropdown(barcode, name, price);
          }
        });
      });
      
      dropdown.style.display = 'block';
    }

    function handleScannerBarcodeInput(inputId, dropdownId) {
      return function() {
        const input = document.getElementById(inputId);
        const results = searchBarcodeProducts(input.value);
        showBarcodeDropdown(results, dropdownId, false);
      };
    }

    function selectFromScannerDropdown(barcode, name, price) {
      document.getElementById('scannerInput').value = barcode;
      document.getElementById('scannerDropdown').style.display = 'none';
      const prod = products.find(p => p.barcode === barcode);
      if (prod) {
        upsertQueueItem({ barcode: prod.barcode, name: prod.name, price: prod.price, quantity: 1 });
        document.getElementById('scannerInput').value = '';
        document.getElementById('scannerInput').focus();
      }
    }

    function handleManualBarcodeinput(inputId, dropdownId) {
      return function() {
        const input = document.getElementById(inputId);
        const results = searchBarcodeProducts(input.value);
        showBarcodeDropdown(results, dropdownId, true);
      };
    }

    function selectFromManualDropdown(barcode, name, price) {
      document.getElementById('manualBarcode').value = barcode;
      document.getElementById('manualName').value = name;
      document.getElementById('manualPrice').value = price;
      document.getElementById('manualBarcodeDropdown').style.display = 'none';
    }

    function handleProductSearch(inputId, dropdownId) {
      return function() {
        const input = document.getElementById(inputId);
        const results = searchBarcodeProducts(input.value);
        
        const dropdown = document.getElementById(dropdownId);
        if (!results || results.length === 0) {
          dropdown.style.display = 'none';
          return;
        }
        
        dropdown.innerHTML = results.map((prod) => `
          <div class="barcode-dropdown-item" data-barcode="${prod.barcode}" data-name="${prod.name}" data-price="${prod.price}" style="cursor: pointer;">
            <div class="dropdown-barcode">${prod.barcode}</div>
            <div class="dropdown-name">${prod.name}</div>
            <div class="dropdown-price">$${sanitizePrice(prod.price)}</div>
          </div>
        `).join('');
        
        // Add click handlers - clicking on product in search dropdown triggers filter
        const items = dropdown.querySelectorAll('.barcode-dropdown-item');
        items.forEach(item => {
          item.addEventListener('click', function() {
            const barcode = this.getAttribute('data-barcode');
            const searchInput = document.getElementById('searchProducts');
            searchInput.value = barcode;
            dropdown.style.display = 'none';
            filterProducts();
          });
        });
        
        dropdown.style.display = 'block';
      };
    }

    function addProductToQueue(barcode) {
      const prod = products.find(p => p.barcode === barcode);
      if (!prod) return;
      upsertQueueItem({ barcode: prod.barcode, name: prod.name, price: prod.price, quantity: 1 });
    }

    function editProduct(index) {
      if (index < 0 || index >= products.length) return;
      editingProductIndex = index;
      const p = products[index];
      document.getElementById('editBarcode').value = p.barcode;
      document.getElementById('editName').value = p.name;
      document.getElementById('editPrice').value = p.price;
      document.getElementById('editModal').classList.add('active');
    }

    function closeEditModal() {
      document.getElementById('editModal').classList.remove('active');
      editingProductIndex = -1;
    }

    function saveEditProduct() {
      if (editingProductIndex < 0) return;
      
      const barcode = document.getElementById('editBarcode').value.trim();
      const name = document.getElementById('editName').value.trim();
      const price = document.getElementById('editPrice').value.trim();
      
      if (!barcode || !name || !price) {
        alert('Please fill all fields!');
        return;
      }
      
      products[editingProductIndex] = normalize({ barcode, name, price });
      filteredProducts = [...products];
      renderProducts();
      closeEditModal();
      alert('Product updated successfully!');
    }

    function deleteProduct(index) {
      if (index < 0 || index >= products.length) return;
      const p = products[index];
      if (confirm(`Delete "${p.name}"?`)) {
        deleteProductFromFirebase(p.barcode); // Remove from Firebase
        products.splice(index, 1);
        filteredProducts = [...products];
        renderProducts();
        alert('Product deleted successfully!');
      }
    }

    function printSelectedLabels() {
      if (queue.length === 0) {
        alert('Please add products to the queue first!');
        return;
      }
      
      if (selectedForPrint.size === 0) {
        alert('Please select at least one product to print!');
        return;
      }
      
      exportLabelsAsPdf();
    }

    // Close label preview after printing from main window
    window.addEventListener('afterprint', () => {
      labelsGrid.innerHTML = '';
      labelsGrid.style.display = 'none';
      const queueActions = document.querySelector('.queue-card .print-actions');
      if (queueActions) queueActions.style.display = 'flex';
    });

    function printAllQueueLabels() {
      if (queue.length === 0) {
        alert('Please add products to the queue first!');
        return;
      }
      // Select everything in the queue
      selectedForPrint.clear();
      for (const q of queue) selectedForPrint.add(q.barcode);
      renderQueue();
      renderLabels();
      exportLabelsAsPdf();
    }

    function exportLabelsAsPdf() {
      if (queue.length === 0) {
        alert('Please add products to the queue first!');
        return;
      }

      if (selectedForPrint.size === 0) {
        alert('Please select at least one product to include in the PDF!');
        return;
      }

      renderLabels();
      const labelsHtml = labelsGrid.innerHTML;
      const pdfWin = window.open('', '_blank');
      if (!pdfWin) {
        alert('Please allow popups to export the PDF.');
        return;
      }

      pdfWin.document.write(`<!doctype html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Gulistan Price Tags - Label Sheet</title>
  <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.6/dist/JsBarcode.all.min.js"><\/script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      -webkit-print-color-adjust: exact !important;
      print-color-adjust: exact !important;
      color-adjust: exact !important;
    }

    @page {
      size: A4 portrait;
      margin: 2.5mm;
    }

    html, body {
      width: 210mm;
      height: 297mm;
      margin: 0;
      padding: 0;
      background: white;
    }

    body {
      display: block;
      margin: 0;
      padding: 0;
      width: 210mm;
      height: 297mm;
    }

    .labels-grid {
      display: grid;
      grid-template-columns: repeat(3, 63.5mm);
      grid-template-rows: repeat(7, 28.1mm);
      gap: 0;
      width: 205mm;
      height: 210mm;
      padding: 0;
      margin: 0;
      background: white;
      border: none;
      page-break-inside: avoid;
    }

    .label {
      width: 63.5mm;
      height: 28.1mm;
      border: 1px solid #000;
      padding: 1.5mm;
      box-sizing: border-box;
      display: flex;
      flex-direction: column;
      justify-content: flex-start;
      background: white;
      page-break-inside: avoid;
      margin: 0;
    }

    .label .name {
      font-size: 11pt;
      font-weight: 700;
      color: #000;
      text-align: center;
      margin: 0 0 0.5mm 0;
      padding: 0;
      line-height: 1.1;
      word-wrap: break-word;
      overflow-wrap: break-word;
      display: block;
      max-height: 6mm;
      overflow: hidden;
    }

    .label .barcode-container {
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 0.3mm 0;
      margin: 0.3mm 4px;
      flex: 0 0 auto;
      background: white;
    }

    .label .barcode {
      width: 100%;
      height: 6mm;
      display: block;
    }

    .label .price {
      font-size: 15pt;
      font-weight: 900;
      color: #000;
      text-align: center;
      margin: 0.3mm 0 0 0;
      padding: 0;
      line-height: 1;
    }

    .label .sku {
      font-size: 8pt;
      color: #000;
      text-align: center;
      margin-top: 0.5mm;
      padding: 0;
      font-family: 'Courier New', monospace;
    }

    @media print {
      body {
        margin: 0 !important;
        padding: 0 !important;
      }
      .labels-grid {
        margin: 0 !important;
        page-break-inside: avoid !important;
      }
    }
  </style>
</head>
<body>
  <div class="labels-grid">${labelsHtml}</div>
</body>
</html>`);
      pdfWin.document.close();
      
      // Generate barcodes in the PDF window
      setTimeout(() => {
        const svgs = pdfWin.document.querySelectorAll('svg.barcode');
        svgs.forEach((svg) => {
          const code = svg.getAttribute('data-barcode') || '';
          if (!code) return;
          try {
            pdfWin.JsBarcode(svg, code, {
              format: 'CODE128',
              width: 1.5,
              height: 25,
              displayValue: false,
              margin: 0,
              background: '#ffffff',
              lineColor: '#000000'
            });
          } catch (e) {
            // If barcode fails, leave the SVG empty
          }
        });
        
        pdfWin.focus();
        setTimeout(() => {
          pdfWin.print();
          // Close preview window after print dialog closes
          pdfWin.onafterprint = () => {
            pdfWin.close();
          };
        }, 100);
      }, 500);
    }

    function toggleSelection(barcode) {
      if (selectedForPrint.has(barcode)) {
        selectedForPrint.delete(barcode);
      } else {
        selectedForPrint.add(barcode);
      }
      renderLabels();
      updateSelectionStatus();
    }

    function selectAll() {
      for (const q of queue) {
        selectedForPrint.add(q.barcode);
      }
      renderQueue();
      renderLabels();
      updateSelectionStatus();
    }

    function deselectAll() {
      selectedForPrint.clear();
      renderQueue();
      renderLabels();
      updateSelectionStatus();
    }

    function selectAllProducts() {
      // Select all products on current page only
      const start = (currentPage - 1) * itemsPerPage;
      const end = start + itemsPerPage;
      const pageProducts = filteredProducts.slice(start, end);
      
      for (const prod of pageProducts) {
        selectedForPrint.add(prod.barcode);
        const existing = queue.find(q => q.barcode === prod.barcode);
        if (!existing) {
          upsertQueueItem({ barcode: prod.barcode, name: prod.name, price: prod.price, quantity: 1 });
        }
      }
      
      renderQueue();
      renderProducts();
      renderLabels();
      updateSelectionStatus();
    }

    function deselectAllProducts() {
      // Deselect all products on current page only
      const start = (currentPage - 1) * itemsPerPage;
      const end = start + itemsPerPage;
      const pageProducts = filteredProducts.slice(start, end);
      
      for (const prod of pageProducts) {
        selectedForPrint.delete(prod.barcode);
      }
      
      renderProducts();
      renderLabels();
      updateSelectionStatus();
    }

    // Select/deselect products directly from All Products table
    function toggleProductSelection(barcode) {
      if (selectedForPrint.has(barcode)) {
        // Deselect only (keep queue intact so qty is preserved if already added)
        selectedForPrint.delete(barcode);
      } else {
        // Select and auto-add to queue if not present
        selectedForPrint.add(barcode);
        const existing = queue.find(q => q.barcode === barcode);
        if (!existing) {
          const prod = products.find(p => p.barcode === barcode);
          if (prod) {
            upsertQueueItem({ barcode: prod.barcode, name: prod.name, price: prod.price, quantity: 1 });
          }
        }
      }
      renderQueue();
      renderLabels();
      updateSelectionStatus();
    }

    function updateSelectionStatus() {
      document.getElementById('selectionStatus').textContent = 
        `${selectedForPrint.size} of ${queue.length} selected for print`;
    }

    // Try to auto-load products.txt when served over HTTP; fallback to manual
    async function autoLoadProducts() {
      try {
        // Attempt to fetch products.txt from the same folder
        const res = await fetch('products.txt', { cache: 'no-store' });
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const text = await res.text();
        const lines = text.split(/\r?\n/).filter(l => l.trim().length);
        if (lines.length < 2) throw new Error('No data lines');
        const headers = lines[0].split(/\t/).map(h => h.trim());
        const idx = (name) => headers.findIndex(h => h.toLowerCase() === name.toLowerCase());
        const iDesc = idx('Description1');
        const iCode = idx('Product Code');
        const iBarcode1 = idx('Barcode1');
        const iPrice1 = idx('Price1');
        const next = [];
        for (let i = 1; i < lines.length; i++) {
          const cols = lines[i].split(/\t/);
          const name = (cols[iDesc] || '').trim();
          const code = (cols[iCode] || '').trim();
          const b1 = (cols[iBarcode1] || '').trim();
          const price = sanitizePrice(cols[iPrice1] || '0');
          const barcode = b1 || code;
          if (!barcode || !name) continue;
          next.push({ barcode, name, price });
        }
        setProducts(next);
        loadStatus.textContent = `Auto-loaded ${products.length} products from products.txt`;
        loadStatus.style.display = 'block';
        console.log(`Auto-loaded ${products.length} products from products.txt`);
      } catch (err) {
        // Expected when opened as file:// - inline data is already loaded
        console.log('Auto-load from products.txt not available (expected for file:// protocol)');
        // Don't overwrite the inline dataset success message
        if (products.length === 0) {
          loadStatus.textContent = 'No data loaded. Use file picker or sample data.';
          loadStatus.style.display = 'block';
        }
      }
    }

    async function init() {
      scannerInput = document.getElementById('scannerInput');
      queueTbody = document.getElementById('queueTbody');
      labelsGrid = document.getElementById('labelsGrid');
      loadStatus = document.getElementById('loadStatus');
      productsTbody = document.getElementById('productsTbody');
      
      // Try loading from Firebase first
      const loadedFromFirebase = await loadProductsFromFirebase();
      
      if (!loadedFromFirebase) {
        // Load inline dataset if Firebase is empty
        if (Array.isArray(window.productDataInline) && window.productDataInline.length > 0) {
          setProducts(window.productDataInline);
          loadStatus.textContent = `Loaded ${products.length} products from inline dataset`;
          loadStatus.style.display = 'block';
          console.log(`Loaded ${products.length} products from inline dataset`);
        } else {
          loadStatus.textContent = 'No inline data found. Load a file or use sample data.';
          loadStatus.style.display = 'block';
          console.warn('window.productDataInline is not available');
        }
        
        // Try auto-load from products.txt if served
        autoLoadProducts();
      }
      
      // Restore selected items from localStorage
      const savedSelections = localStorage.getItem('gulistanSelectedItems');
      if (savedSelections) {
        try {
          const savedArray = JSON.parse(savedSelections);
          savedArray.forEach(item => selectedForPrint.add(item));
          console.log('Restored selections:', Array.from(selectedForPrint));
        } catch (e) {
          console.log('Could not restore selections');
        }
      }
      
      renderQueue();
      scannerInput.focus();
      
      // Don't auto-start camera - let user click the button
      // Camera needs user interaction for permissions
      console.log('Camera scanner ready. Click "Start Camera" button to begin scanning.');
    }

    window.removeQueueItem = removeQueueItem;
    window.clearQueue = clearQueue;
    window.handleFile = handleFile;
    window.handleScanSubmit = handleScanSubmit;
    window.startCameraScanner = startCameraScanner;
    window.stopCameraScanner = stopCameraScanner;
    window.handleManualAdd = handleManualAdd;
    window.loadSample = loadSample;
    window.filterProducts = filterProducts;
    window.changePage = changePage;
    window.addProductToQueue = addProductToQueue;
    window.editProduct = editProduct;
    window.deleteProduct = deleteProduct;
    window.closeEditModal = closeEditModal;
    window.saveEditProduct = saveEditProduct;
    window.printSelectedLabels = printSelectedLabels;
    window.printAllQueueLabels = printAllQueueLabels;
    window.exportLabelsAsPdf = exportLabelsAsPdf;
    window.searchBarcodeProducts = searchBarcodeProducts;
    window.showBarcodeDropdown = showBarcodeDropdown;
    window.selectFromScannerDropdown = selectFromScannerDropdown;
    window.selectFromManualDropdown = selectFromManualDropdown;
    window.handleScannerBarcodeInput = handleScannerBarcodeInput;
    window.handleManualBarcodeinput = handleManualBarcodeinput;
    window.handleProductSearch = handleProductSearch;
    window.exportToExcel = exportToExcel;
    window.toggleProductSelection = toggleProductSelection;
    window.toggleSelection = toggleSelection;
    window.selectAll = selectAll;
    window.deselectAll = deselectAll;
    window.selectAllProducts = selectAllProducts;
    window.deselectAllProducts = deselectAllProducts;

    // Close barcode dropdowns when clicking outside
    document.addEventListener('click', function(event) {
      const scannerDropdown = document.getElementById('scannerDropdown');
      const manualDropdown = document.getElementById('manualBarcodeDropdown');
      const searchDropdown = document.getElementById('searchProductsDropdown');
      const scannerInput = document.getElementById('scannerInput');
      const manualInput = document.getElementById('manualBarcode');
      const searchInput = document.getElementById('searchProducts');
      
      // Close scanner dropdown if clicking outside its input wrapper
      if (scannerDropdown && event.target !== scannerInput && !scannerInput.contains(event.target)) {
        if (!scannerDropdown.contains(event.target)) {
          scannerDropdown.style.display = 'none';
        }
      }
      
      // Close manual dropdown if clicking outside its input wrapper
      if (manualDropdown && event.target !== manualInput && !manualInput.contains(event.target)) {
        if (!manualDropdown.contains(event.target)) {
          manualDropdown.style.display = 'none';
        }
      }
      
      // Close search dropdown if clicking outside its input wrapper
      if (searchDropdown && event.target !== searchInput && !searchInput.contains(event.target)) {
        if (!searchDropdown.contains(event.target)) {
          searchDropdown.style.display = 'none';
        }
      }
    });

    window.addEventListener('DOMContentLoaded', init);
    
    // Register Service Worker for PWA
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', function() {
        navigator.serviceWorker.register('./service-worker.js')
          .then(function(registration) {
            console.log('Service Worker registered successfully:', registration.scope);
          })
          .catch(function(error) {
            console.log('Service Worker registration failed:', error);
          });
      });
    }
  </script>
</head>
<body>
  <header>
    <img src="logo.png" alt="Gulistan Logo" style="height: 40px; vertical-align: middle; margin-right: 12px;" />
    <h1 style="display: inline; vertical-align: middle;">Gulistan Price Tags</h1>
    <button class="primary" onclick="syncToFirebase()" style="float: right; margin: 8px; padding: 8px 16px; font-size: 14px;" title="Sync all products to Firebase">☁️ Sync to Cloud</button>
    <button class="primary" onclick="loadFromFirebase()" style="float: right; margin: 8px; padding: 8px 16px; font-size: 14px;" title="Load products from Firebase">⬇️ Load from Cloud</button>
  </header>

  <main>
    <div class="row">
      <div class="glass-card controls">
        <h3>📂 Load Products Data</h3>
        <div id="loadStatus" style="color: var(--success); font-size: 14px; font-weight: 600; margin-bottom: 12px; padding: 12px; background-color: #d5f4e6; border-radius: 4px; border-left: 4px solid var(--success);">
          Loading products...
        </div>
        <label for="fileInput">Select products.txt file to override</label>
        <input type="file" id="fileInput" accept=".txt" onchange="handleFile(event)" />
        <div class="actions-group">
          <button class="primary" onclick="loadSample()">Load Sample Data</button>
        </div>
      </div>

      <div class="glass-card controls">
        <h3>Scan Barcode</h3>
        <div id="cameraStatus" style="display: none; padding: 8px 12px; margin-bottom: 12px; background: linear-gradient(135deg, #5cb85c 0%, #4caf50 100%); color: white; border-radius: 6px; font-size: 13px; font-weight: 600; text-align: center; box-shadow: 0 2px 8px rgba(92, 184, 92, 0.3);">
          🎥 Advanced Camera Scanner Active - Ready to Scan
        </div>
        <label for="scannerInput">Scan or type barcode</label>
        <div class="barcode-input-wrapper">
          <input type="text" id="scannerInput" placeholder="Scan barcode here..." autofocus oninput="handleScannerBarcodeInput('scannerInput', 'scannerDropdown')()" />
          <div id="scannerDropdown" class="barcode-dropdown"></div>
        </div>
        
        <div class="actions-group">
          <button class="primary" onclick="handleScanSubmit(event)">Add to Queue</button>
          <button id="toggleCameraBtn" class="primary" style="background-color: #5cb85c;" onclick="startCameraScanner('scannerInput')">Start Camera</button>
        </div>
        
        <!-- Small Camera Preview Below Buttons -->
        <div id="cameraScannerSection" style="display: none; margin: 12px 0; overflow: hidden;">
          <div id="cameraVideo" style="width: 280px; height: 180px; border: 2px solid #5cb85c; border-radius: 6px; background: #000; margin: 0 auto; overflow: hidden; position: relative;"></div>
          <p style="color: #666; font-size: 11px; margin-top: 6px; text-align: center;">Point camera at barcode</p>
        </div>
      </div>

      <div class="glass-card controls">
        <h3>➕ Manual Add</h3>
        <label for="manualBarcode">Barcode</label>
        <div class="barcode-input-wrapper" style="display: flex; gap: 8px; align-items: flex-start;">
          <div style="flex: 1; position: relative;">
            <input type="text" id="manualBarcode" placeholder="Enter barcode..." oninput="handleManualBarcodeinput('manualBarcode', 'manualBarcodeDropdown')()" />
            <div id="manualBarcodeDropdown" class="barcode-dropdown"></div>
          </div>
          <button class="primary" onclick="startCameraScanner('manualBarcode')" style="padding: 10px 20px; white-space: nowrap;">Scan</button>
        </div>
        <label for="manualName">Product Name</label>
        <input type="text" id="manualName" placeholder="Enter name..." oninput="handleNameInput()" />
        <label for="manualPrice">Price ($)</label>
        <input type="text" id="manualPrice" placeholder="0.00" />
        <div class="actions-group">
          <button class="primary" onclick="handleManualAdd(event)">Add to Queue</button>
        </div>
      </div>
    </div>

    <div class="glass-card queue-card">
      <h3>Print Queue (<span id="queueCount">0</span> items) - <span id="selectionStatus" style="font-size: 14px; color: var(--dark);">0 selected</span></h3>
      <div style="overflow-x:auto; margin-bottom: 16px;">
        <table>
          <thead>
            <tr>
              <th style="width: 40px;">Select</th>
              <th>Barcode</th>
              <th>Name</th>
              <th>Price</th>
              <th>Qty</th>
              <th></th>
            </tr>
          </thead>
          <tbody id="queueTbody"></tbody>
        </table>
      </div>
      <div class="print-actions" style="display: flex; gap: 12px; flex-wrap: wrap; margin-bottom: 12px;">
        <button class="primary" onclick="selectAll()">Select All</button>
        <button class="primary" onclick="deselectAll()">⬜ Deselect All</button>
      </div>
      <div class="print-actions">
        <button class="primary" onclick="renderLabels()">Preview Selected</button>
        <button class="primary" onclick="printSelectedLabels()">Print Selected</button>
        <button class="primary" onclick="exportLabelsAsPdf()">Save as PDF</button>
        <button class="primary" onclick="exportToExcel()">Export to Excel</button>
        <button class="primary" onclick="printAllQueueLabels()">Print All</button>
        <button onclick="clearQueue()">Clear Queue</button>
      </div>
    </div>

    <div class="glass-card">
      <h3>📦 All Products (<span id="productsCount">0</span> items)</h3>
      <div class="barcode-input-wrapper" style="position: relative; margin-bottom: 12px; display: flex; gap: 8px;">
        <input type="text" id="searchProducts" class="search-box" placeholder="Search products by name, barcode, or price..." oninput="handleProductSearch('searchProducts', 'searchProductsDropdown')(); filterProducts();" style="flex: 1;" />
        <button class="primary" onclick="startCameraScanner('searchProducts')" style="padding: 10px 20px; white-space: nowrap;">Scan</button>
        <div id="searchProductsDropdown" class="barcode-dropdown" style="width: calc(100% - 2px); max-width: calc(100% - 2px);"></div>
      </div>
      <div class="print-actions" style="margin-bottom: 12px;">
        <button class="primary" onclick="selectAllProducts()">✅ Select All (Page)</button>
        <button class="primary" onclick="deselectAllProducts()">⬜ Deselect All (Page)</button>
      </div>
      <div class="products-table-container">
        <table id="productsTable">
          <thead>
            <tr>
              <th style="width: 40px;">Select</th>
              <th>Barcode</th>
              <th>Product Name</th>
              <th>Price ($)</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="productsTbody"></tbody>
        </table>
      </div>
      <div class="pagination">
        <button onclick="changePage(-1)" id="prevPageBtn">Previous</button>
        <span class="page-info">Page <span id="currentPage">1</span> of <span id="totalPages">1</span></span>
        <button onclick="changePage(1)" id="nextPageBtn">Next</button>
      </div>
      <div class="print-actions" style="margin-top: 12px;">
        <button class="primary" onclick="selectAllProducts()">✅ Select All (Page)</button>
        <button class="primary" onclick="deselectAllProducts()">⬜ Deselect All (Page)</button>
      </div>
    </div>

    <div class="glass-card labels-card">
      <h3>Label Preview</h3>
      <p style="color: var(--dark); font-size: 13px; margin-bottom: 16px;">
        <strong>Print Settings:</strong> Use CODE128 format with SVG for maximum scanner readability. 
        Labels: 63.5mm × 20mm preview / 28.1mm print. Best printed on A4 sticker sheets (21 labels per page).
      </p>
      <div id="labelsGrid" class="labels-grid"></div>
    </div>
  </main>

  <!-- Edit Product Modal -->
  <div id="editModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>Edit Product</h3>
        <button class="close-btn" onclick="closeEditModal()">&times;</button>
      </div>
      <div class="form-group">
        <label for="editBarcode">Barcode</label>
        <input type="text" id="editBarcode" placeholder="Enter barcode..." />
      </div>
      <div class="form-group">
        <label for="editName">Product Name</label>
        <input type="text" id="editName" placeholder="Enter product name..." />
      </div>
      <div class="form-group">
        <label for="editPrice">Price ($)</label>
        <input type="text" id="editPrice" placeholder="0.00" />
      </div>
      <div class="actions-group">
        <button class="primary" onclick="saveEditProduct()">Save Changes</button>
        <button onclick="closeEditModal()">Cancel</button>
      </div>
    </div>
  </div>
</body>
</html>
